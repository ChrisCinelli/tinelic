<!DOCTYPE html>
<html>
<head>
<title>Hey, wei!</title>
<script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.1.15/require.js"></script>
<script src="//code.jquery.com/jquery-2.1.3.js"></script>
<script>
requirejs.config({
    baseUrl: "app",
    paths:{
		"tinybone":"../tinybone",
		"lodash":"//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash",
		"dust":"//cdnjs.cloudflare.com/ajax/libs/dustjs-linkedin/2.5.1/dust-core"
	},
	shim: {
		'dust': {
			exports: 'dust'
		}
	}
})
</script>
</head>
<body>
<div id="content">
{@view name=view/}
</div>
<script>
requirejs(["routes","lodash","dust","safe"], function (routes,_,dust,safe) {
if (!dust.helpers)
    dust.helpers = {};

var app = {
	loadTemplates: function (names, cb) {
		safe.each(names, function (name, cb) {
			requirejs(["dustjs/"+name], function (template) {
				dust.loadSource(template);
				cb();
			},cb)
		},cb);
	}
}

dust.helpers.view = function(chunk, context, bodies, params) {
    return chunk.map(function(chunk) {
		requirejs(['views/'+params.name], function (View) {
			var view = new View(app);
			app.loadTemplates(view.tpls?view.tpls:[params.name], function () {
				view.render(function (err,text) {
					chunk.end(text);
				})
			})
		})
    });
};


$("body").on("click","a", function (e) {
	e.preventDefault();
	$this = $(this);
	var uri = $this.attr("href");
	function next (err) {
		if (err) console.log(err);
	}
	_.each(routes, function (v,k) {
		if (k=="/"+uri || (k.length==0 && uri==".")) {
			requirejs(['routes/'+v],function (route) {
				route.data(safe.sure(next,function (data) {
					app.loadTemplates([data.view], safe.sure(next, function () {
						dust.render(data.view,data, safe.sure(next, function (text) {
							$("#content").html(text);
						}))
					}))
				}))
			})
		}
	})
	return false;
})

})
</script>
</body>
</html>
